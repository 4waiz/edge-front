<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EDGE Voice Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141a; --muted:#9aa0a6; --text:#e6e9ef;
      --accent:#ff7a1a; --accent-2:#222833; --ok:#22c55e; --err:#ef4444;
      --border:#2a2f36; --bubble-me:#1f2a36; --bubble-bot:#13202b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 1200px at 50% -20%, #151821 0%, #0b0c10 50%, #000 100%);
      color:var(--text); font-family:'Montserrat',system-ui,Segoe UI,Roboto,sans-serif;
      overflow:hidden; /* page never scrolls */
    }
    .wrap{height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px;padding:18px;  min-height:0;} 
    .topbar{display:flex;align-items:center;gap:14px;justify-content:center; flex-wrap: wrap}
    .logo{height:80px;object-fit:contain;filter:drop-shadow(0 8px 24px rgba(0,0,0,.45)); order:-1; flex:0 0 100%; display:block; margin:0 auto 6px;}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:999px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .pill.secondary{background:var(--accent-2);color:var(--text);border:1px solid var(--border)}
    .pill[disabled]{opacity:.6;cursor:not-allowed}
    .status{padding:10px 16px;border-radius:999px;background:var(--accent-2);border:1px solid var(--border);color:#c7d1db}
    .status.idle{background:#1a212a}
    .status.listen{background:#0f2c1a;border-color:#1b4d2e;color:#cfeedd}
    .status.speak{background:#2b1a1a;border-color:#5b2a2a;color:#ffd8d8}
    .hint{color:var(--muted);background:#0e1217;border:1px solid var(--border);padding:10px 14px;border-radius:999px}

    .card{
      height:100%;max-width:1260px;margin:0 auto;width:100%;
      display:grid;grid-template-rows:auto 1fr auto;gap:14px;
      background:rgba(16,18,24,.4);backdrop-filter:blur(6px);
      border:1px solid #1e2430;border-radius:18px;padding:16px 16px 14px;
      box-shadow:0 30px 80px rgba(0,0,0,.45); min-height:0; 
    }
    .sysline{color:#c4cad4;background:#0e1116;border:1px dashed #283140;border-radius:12px;padding:12px 16px}
    .scroll{
      overflow-y:auto;
      max-height: clamp(240px, 50vh, 640px);          /* was overflow:auto — fine too */
      min-height:0;              /* NEW */
      -webkit-overflow-scrolling:touch;  /* optional */
      overscroll-behavior:contain;       /* optional */
      border-radius:14px;
      background:#0d1218;
      border:1px solid var(--border);
      padding:14px;
      display:grid;
      gap:12px;
      }
    .msg{padding:12px 16px;border-radius:14px;line-height:1.55;max-width:80%}
    .me{justify-self:end;background:var(--bubble-me)}
    .bot{justify-self:start;background:var(--bubble-bot)}
    .err{background:#3b1d1d;border:1px solid #7a2e2e;color:#f3caca}
    textarea{
      width:100%;background:#0c1015;color:var(--text);border:1px solid var(--border);
      border-radius:14px;padding:14px 16px;font-family:inherit;resize:none;height:84px
    }
    .row{display:grid;grid-template-columns:1fr auto;gap:14px}
    .send{min-width:130px}
    .btn{border:0;padding:18px 22px;border-radius:16px;font-weight:800;cursor:pointer;
      background:var(--accent);color:white; font-size:18px;letter-spacing:.2px;
      box-shadow:0 10px 30px rgba(255,122,26,.25)
    }
    .btn:active{transform:translateY(1px)}
    .footer{color:#aab2bd;text-align:center}
    .footer a{color:#a7d7ff;text-decoration:none;border-bottom:1px solid rgba(167,215,255,.35)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="topbar">
      <button id="toggle" class="pill">Voice Off</button>
      <div class="hint">Tip: press <b>M</b> to toggle mic</div>
      <div id="vstat" class="pill secondary status idle">Idle</div>
      <img src="/logo.png" alt="EDGE LIF" class="logo">
    </div>

    <!-- Main card -->
    <div class="card">
      <div class="sysline">Voice is optional. Press “Start Voice” and allow the microphone, or type a message.</div>
      <div id="log" class="scroll"></div>

      <div class="row">
        <textarea id="input" placeholder="Type a message…  (Enter to send, Shift+Enter for newline)"></textarea>
        <button id="send" class="btn send">Send</button>
      </div>
    </div>

    <div class="footer">Created by <a href="https://www.linkedin.com/in/awaiz-ahmed/" target="_blank" rel="noopener">Awaiz Ahmed & Yumna Salaas</a></div>
  </div>

  <script>
    // ----------------------- Helpers & UI -----------------------
    const $ = s => document.querySelector(s);
    const log = $('#log'), input = $('#input'), sendBtn = $('#send');
    const toggleBtn = $('#toggle'), voiceStatus = $('#vstat');
    const SHOW_DIAGS = false;

    function push(role, text, cls=''){
      const div = document.createElement('div');
      div.className = `msg ${role==='user'?'me':'bot'} ${cls}`;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }
    function showStatus(kind, text){
      voiceStatus.className = `pill secondary status ${kind}`;
      voiceStatus.textContent = text;
    }

    const history = [];
    function limitWords(s, n=70){
      const words = String(s||'').trim().split(/\s+/);
      return words.length > n ? words.slice(0, n).join(' ') + '…' : s;
    }

    // ----------------------- TTS (Emily preferred) -----------------------
    let voice = null;
    const FORCE_VOICE_NAME = '';   // <-- set to a female voice name to hard-lock it
    const FEMALE_VOICE_HINTS = [
      'Microsoft Emily', 'Emily', 'Microsoft Zira', 'Zira',
      'Samantha', 'Victoria', 'Serena', 'Moira', 'Tessa', 'Karen', 'Kate', 'Susan',
      'Google UK English Female', 'Google US English',
      'Wavenet-F', 'Neural2-F' // some browsers/vendors use these patterns
    ];

    function chooseVoice(){
      const voices = window.speechSynthesis.getVoices() || [];
      voice = null;

      // 1) Hard lock by exact name if provided
      if (FORCE_VOICE_NAME) {
        voice = voices.find(v => v.name.includes(FORCE_VOICE_NAME)) || null;
      }

      // 2) Prefer English female-ish names
      if (!voice) {
        const en = voices.filter(v => /^en[-_]/i.test(v.lang));
        voice = en.find(v =>
          FEMALE_VOICE_HINTS.some(h => v.name.toLowerCase().includes(h.toLowerCase()))
        ) || null;
      }

      // 3) Fallback: any English voice, then any voice
      if (!voice) voice = voices.find(v => /^en[-_]/i.test(v.lang)) || voices[0] || null;
    }
    window.speechSynthesis.onvoiceschanged = chooseVoice;
    chooseVoice();

    let speaking = false;
    function speak(text){
      if (!voiceOn) return;               // speak only when Voice is On
      try{
        const u = new SpeechSynthesisUtterance(text);
        if (voice) u.voice = voice;
        u.rate = 1.0;                      // normal rate
        u.onstart = ()=>{ speaking = true; showStatus('speak','Speaking'); };
        u.onend   = ()=>{ speaking = false; showStatus(listening?'listen':'idle', listening?'Listening':'Idle'); };
        window.speechSynthesis.cancel();   // clear any queue
        window.speechSynthesis.speak(u);
      }catch(e){ console.warn('TTS error', e); }
    }
    function stopSpeaking(){
      try{ window.speechSynthesis.cancel(); }catch(e){}
      speaking = false;
    }

    // ----------------------- STT (webkitSpeechRecognition) -----------------------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false, lastTranscript = '';

    function initSR(){
      if (!SR) return;
      rec = new SR();
      rec.lang = 'en-US';
      rec.continuous = false;
      rec.interimResults = true;
      rec.maxAlternatives = 1;

      rec.onstart = () => { listening = true; showStatus('listen','Listening'); };
      rec.onerror = (e) => { showStatus('idle','Idle'); console.warn('ASR error', e); listening=false; };
      rec.onend = async () => {
        listening = false;
        showStatus('idle','Idle');
        const text = squash(lastTranscript).trim();
        lastTranscript = '';
        if (text) await handleUserText(text);
        setTimeout(()=> { if (voiceOn) startSR(); }, 1000);
      };
      rec.onresult = (ev) => {
        let final = '';
        for (let i=ev.resultIndex; i<ev.results.length; i++){
          const r = ev.results[i];
          if (r.isFinal) final += r[0].transcript + ' ';
          else lastTranscript = r[0].transcript;
        }
        if (final) lastTranscript += ' ' + final;
      };
    }
    initSR();

    function squash(t){
      return String(t||'')
        .replace(/\s+/g,' ')
        .replace(/\b(\w+)( \1\b)+/gi,'$1'); // hello hello hello -> hello
    }

    let voiceOn = false;
    function startSR(){ if (rec) try{ rec.start(); }catch{} }
    function stopSR(){ if (rec) try{ rec.stop(); }catch{} listening=false; showStatus('idle','Idle'); }

    document.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='m'){ e.preventDefault(); toggleVoice(); }});
    toggleBtn.onclick = toggleVoice;

    function toggleVoice(){
      voiceOn = !voiceOn;
      toggleBtn.textContent = voiceOn ? 'Voice On' : 'Voice Off';
      if (voiceOn){ stopSpeaking(); startSR(); }
      else { stopSR(); stopSpeaking(); }
    }
    // example handlers:
    document.getElementById('btnVoice').onclick = () => {
      const on = !document.body.classList.contains('voice-on');
      document.body.classList.toggle('voice-on', on);
      toggleVoice(on);
      // update status pill from Idle <-> Listening here
    };
    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'm') {
        const on = !document.body.classList.contains('voice-on');
        document.body.classList.toggle('voice-on', on);
        toggleVoice(on);
      }
    });

    // ----------------------- Chat (calls /api/chat) -----------------------
    async function postJSON(url, payload){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const text = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status} – ${text}`);
      return JSON.parse(text);
    }

    async function handleUserText(text){
      push('user', text);
      history.push({role:'user', content:text});
      try{
        stopSR();
        const res = await postJSON('/api/chat', {messages: history.slice(-8)});
        const raw = res.reply || '';
        const reply = limitWords(raw, 100);
        history.push({role:'assistant', content:reply});
        push('assistant', reply);
        speak(reply);
      }catch(e){
        push('assistant', `[error] ${e.message}`, 'err');
      }finally{
        // after 1s, resume listening automatically if voice mode is on
        setTimeout(()=>{ if (voiceOn) startSR(); }, 1000);
      }
    }

    sendBtn.onclick = async ()=>{
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      await handleUserText(text);
      input.focus();
    };
    input.addEventListener('keydown', (ev)=>{
      if (ev.key==='Enter' && !ev.shiftKey){
        ev.preventDefault(); sendBtn.click();
      }
    });

    // If user starts talking while TTS is speaking, interrupt speech and switch to listening
    document.addEventListener('visibilitychange',()=>{}); // no-op; keeps audio context warm
    // Minimal diagnostics for Double
    if (SHOW_DIAGS) (function(){
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;left:12px;bottom:12px;z-index:9999;background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:12px 14px;font:12px/1.3 system-ui;max-width:420px';
      el.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px">Diagnostics</div>
        <div>UA: <code style="font-size:11px">${navigator.userAgent}</code></div>
        <div>SpeechRecognition: <b>${'webkitSpeechRecognition'in window || 'SpeechRecognition'in window}</b></div>
        <div>speechSynthesis: <b>${'speechSynthesis'in window}</b></div>
        <div>getUserMedia: <b>${!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}</b></div>
        <div id="perm">Mic permission: <i>checking…</i></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="beep" style="padding:6px 10px;border-radius:8px;border:0;background:#f97316;color:#fff;cursor:pointer">Play test beep</button>
          <button id="mic" style="padding:6px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;cursor:pointer">Mic test</button>
        </div>
      `;
      document.body.appendChild(el);

      // Autoplay / TTS unlock test
      document.getElementById('beep').onclick = async () => {
        try {
          const ctx = new (window.AudioContext||window.webkitAudioContext)();
          await ctx.resume();
          const o = ctx.createOscillator(); o.connect(ctx.destination); o.start(); setTimeout(()=>o.stop(), 250);
          if (speechSynthesis) { const u = new SpeechSynthesisUtterance('Audio unlocked'); speechSynthesis.speak(u); }
        } catch (e) { alert('Audio error: ' + e); }
      };

      // Mic permission + gUM test
      (async () => {
        const permEl = document.getElementById('perm');
        try {
          if (!navigator.permissions) { permEl.innerHTML = 'Mic permission: <b>unknown</b>'; return; }
          const st = await navigator.permissions.query({ name: 'microphone' });
          permEl.innerHTML = 'Mic permission: <b>'+ st.state +'</b>';
        } catch { permEl.innerHTML = 'Mic permission: <b>unknown</b>'; }
      })();

      document.getElementById('mic').onclick = async () => {
        try {
          const s = await navigator.mediaDevices.getUserMedia({ audio: true });
          const tracks = s.getAudioTracks();
          alert('Mic gUM success. Track: ' + (tracks[0] && tracks[0].label || 'OK'));
          s.getTracks().forEach(t=>t.stop());
        } catch (e) {
          alert('Mic blocked: ' + e.message);
        }
      };
    })();
</script>

</body>
</html>
