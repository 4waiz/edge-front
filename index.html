<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EDGE Voice Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#0b0c10; --panel:#121a; --muted:#9aa0a6; --text:#e6e9ef;
      --accent:#ff7a1a; --accent-2:#222833; --ok:#22c55e; --err:#ef4444;
      --border:#2a2f36;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin: 0;}
    
    body{
      background: radial-gradient(ellipse at 50% 50%, #3d1b63, #0b0c10 75%);
      color:var(--text); 
      font-family:'Montserrat',system-ui,Segoe UI,Roboto,sans-serif;
      overflow:hidden;
    }

    .bg-mesh{position:fixed; inset:0; z-index:-1; overflow:hidden;}
    #mesh{display:block; width:100%; height:100%}

    .wrap{
      height:100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      align-items: center;
      gap: 20px;
      padding: 20px 18px;
    }
    .topbar{display:flex;align-items:center;gap:14px;justify-content:center;flex-wrap:wrap; width: 100%;}
    .logo{height:100px; object-fit:contain;filter:drop-shadow(0 8px 24px rgba(0,0,0,.45));order:-1;flex:0 0 100%;display:block;margin:0 auto 13px;}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:999px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .pill.secondary{background:var(--accent-2);color:var(--text);border:1px solid var(--border)}
    .status{padding:10px 16px;border-radius:999px;background:var(--accent-2);border:1px solid var(--border);color:#c7d1db; transition: background .3s, border-color .3s, color .3s;}
    .status.idle{background:#1a212a}
    .status.listen{background:#0f2c1a;border-color:#1b4d2e;color:#cfeedd}
    .status.speak{background:#2b1a1a;border-color:#5b2a2a;color:#ffd8d8}
    .hint{color:var(--muted);background:#0e1217;border:1px solid var(--border);padding:10px 14px;border-radius:999px}

    .card{ width:100%; display:flex; justify-content:center; align-items:center; border:none; background:transparent; box-shadow:none; }
    .footer {color: #aab2bd; text-align: center; font-size: 19px;}
    .footer a{color:#a7d7ff;text-decoration:none;border-bottom:1px solid rgba(167,215,255,.35)}

    .blob-wrap{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:20px; text-align:center;
    }
    .blob{
      width:min(35vh, 380px); height:min(35vh, 380px);
      position:relative; display:flex;align-items:center;justify-content:center;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, #150522, #000);
      will-change: transform, border-radius; overflow: hidden;
      filter: drop-shadow(0 0 25px rgba(238, 0, 255, 0.5)) drop-shadow(0 0 45px rgba(0, 204, 255, 0.4));
      animation:
        wobble-organic 15s ease-in-out infinite,
        floaty 12s ease-in-out infinite;
    }
    .blob::before {
      content: ''; position: absolute; inset: -100%;
      background: conic-gradient(from 90deg, #ee00ff, #6600ff, #00ccff, #ee00ff);
      animation: spin 15s linear infinite;
      mix-blend-mode: screen; opacity: 0.9; transition: opacity .5s ease;
    }
    .blob::after {
      content: ''; position: absolute; inset: -50%;
      background: conic-gradient(from 0deg, transparent, #fff, transparent 40%);
      animation: spin 22s linear infinite reverse;
      mix-blend-mode: overlay; opacity: 0.3;
    }
    .blob-content { z-index: 10; position: relative; }
    
    .blob h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 800;
      font-size: clamp(20px, 3.2vw, 36px);
      margin: 0 18px;
      color: #e8eef8;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3),
                   0 0 25px rgba(238, 0, 255, 0.6),
                   0 0 40px rgba(0, 204, 255, 0.5);
      transition: opacity .4s ease;
      min-height: 1.2em;
    }

    .typing::after {
      content: '▋'; display: inline-block; margin-left: 0.1em;
      color: #00ccff; animation: blink 0.8s infinite;
    }
    
    #waveCanvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; z-index: 5;
      opacity: 0; transition: opacity .4s ease;
    }
    .blob.listening h1,
    .blob.speaking h1 { opacity: 0.1; }
    .blob.listening::before { opacity: 0.4; }
    .blob.listening #waveCanvas { opacity: 1; }
    .blob.speaking {
      animation:
        wobble-organic 15s ease-in-out infinite,
        speaking-pulse 1.8s ease-in-out infinite;
    }
    .subtitle{
      color: #b9c1d0; font-size: clamp(17px, 1.6vw, 20px);
      font-weight: 500; max-width:480px; opacity: 0.9;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes floaty {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    @keyframes wobble-organic {
      0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
      25% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
      50% { border-radius: 60% 40% 50% 60% / 70% 50% 40% 30%; }
      75% { border-radius: 40% 70% 30% 60% / 60% 40% 70% 30%; }
      100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
    }
    @keyframes speaking-pulse {
      0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 25px #ee00ff55) drop-shadow(0 0 45px #00ccff44); }
      50% { transform: translateY(-10px); filter: drop-shadow(0 0 40px #ee00ffaa) drop-shadow(0 0 65px #00ccff88); }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="bg-mesh">
    <canvas id="mesh"></canvas>
  </div>

  <div class="wrap">
    <div class="topbar">
      <img src="/logo.png" alt="EDGE LIF" class="logo">
      <button id="toggle" class="pill">Voice Off</button>
      <div class="hint">Tip: press <b>M</b> to toggle mic</div>
      <div id="vstat" class="pill secondary status idle">Idle</div>
    </div>

    <div class="card">
      <div class="blob-wrap">
        <div class="blob" aria-live="polite">
          <canvas id="waveCanvas"></canvas>
          <div class="blob-content">
            <h1></h1>
          </div>
        </div>
        <p class="subtitle">Join us to know more about innovation @EDGE tomorrow from 11:30 - 12:30 in HQ auditorium</p>
      </div>
    </div>

    <div class="footer">Created by <a href="https://www.linkedin.com/in/awaiz-ahmed/" target="_blank" rel="noopener">Awaiz Ahmed &amp; Yumna Salaas</a></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const toggleBtn = $('#toggle'), voiceStatus = $('#vstat'), blob = $('.blob');
    const history = [];
    function push(){ /* intentionally empty */ }
    function showStatus(kind, text) {
      voiceStatus.className = `pill secondary status ${kind}`;
      voiceStatus.textContent = text;
      blob.classList.remove('listening', 'speaking');
      stopWaveAnimation();
      if (kind === 'listen') { blob.classList.add('listening'); startWaveAnimation(); }
      else if (kind === 'speak') { blob.classList.add('speaking'); }
    }
    let voice = null;
    const FEMALE_VOICE_HINTS = ['Microsoft Emily','Emily','Microsoft Zira','Zira','Samantha','Victoria','Google UK English Female','Google US English','Wavenet-F','Neural2-F'];
    function chooseVoice(){
      const voices = window.speechSynthesis.getVoices() || [];
      const en = voices.filter(v => /^en[-_]/i.test(v.lang));
      voice = en.find(v => FEMALE_VOICE_HINTS.some(h => v.name.includes(h))) || en[0] || voices[0];
    }
    window.speechSynthesis.onvoiceschanged = chooseVoice;
    chooseVoice();
    let speaking = false;
    function speak(text){
      if (!voiceOn) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        if (voice) u.voice = voice;
        u.rate = 1.0;
        u.onstart = ()=>{ speaking = true; showStatus('speak','Speaking'); };
        u.onend   = ()=>{ speaking = false; showStatus(listening?'listen':'idle', listening?'Listening':'Idle'); };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){ console.warn('TTS error', e); }
    }
    function stopSpeaking(){ try{ window.speechSynthesis.cancel(); }catch(e){} speaking = false; }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false, lastTranscript = '';
    function initSR(){
      if (!SR) return;
      rec = new SR();
      rec.lang = 'en-US'; rec.continuous = false; rec.interimResults = true; rec.maxAlternatives = 1;
      rec.onstart = () => { listening = true; showStatus('listen','Listening'); };
      rec.onerror = (e) => { listening=false; showStatus('idle','Idle'); console.warn('ASR error', e); };
      rec.onend = async () => {
        listening = false; showStatus('idle','Idle'); const text = (lastTranscript || '').trim(); lastTranscript = '';
        if (text) await handleUserText(text);
        if (voiceOn) setTimeout(()=> startSR(), 500);
      };
      rec.onresult = (ev) => {
        let final = '', interim = '';
        for (let i=ev.resultIndex; i<ev.results.length; i++){
          const r = ev.results[i]; if (r.isFinal) final += r[0].transcript + ' '; else interim += r[0].transcript;
        }
        lastTranscript = final || interim;
      };
    }
    initSR();
    let voiceOn = false;
    function startSR(){ if (rec && !listening) try{ rec.start(); }catch(e){console.error(e)} }
    function stopSR(){ if (rec) try{ rec.stop(); }catch{} listening=false; showStatus('idle','Idle'); }
    document.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='m'){ e.preventDefault(); toggleVoice(); }});
    toggleBtn.onclick = toggleVoice;
    function toggleVoice(){
      voiceOn = !voiceOn; toggleBtn.textContent = voiceOn ? 'Voice On' : 'Voice Off';
      if (voiceOn){ stopSpeaking(); startSR(); } else { stopSR(); stopSpeaking(); }
    }
    async function postJSON(url, payload){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const text = await r.text(); if (!r.ok) throw new Error('HTTP ' + r.status + ' ' + text); return JSON.parse(text);
    }
    async function handleUserText(text){
      history.push({role:'user', content:text});
      try{
        stopSR();
        const res = await postJSON('/api/chat', {messages: history.slice(-8)});
        const raw = res.reply || '';
        const reply = raw.split(/\s+/).slice(0, 100).join(' ') + (raw.split(/\s+/).length > 100 ? '…' : '');
        history.push({role:'assistant', content:reply}); speak(reply);
      }catch(e){ console.warn('Chat error', e); speak('Sorry, I had trouble reaching the server.'); }
    }
    const canvas = document.getElementById('waveCanvas'); const ctx = canvas.getContext('2d');
    let animationFrameId = null;
    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1; const size = blob.clientWidth;
        canvas.width = size * dpr; canvas.height = size * dpr; ctx.scale(dpr, dpr);
    }
    const waves = [{color:'rgba(238,0,255,0.7)',amp:30,freq:0.02,phase:0,speed:0.03},{color:'rgba(0,204,255,0.8)',amp:40,freq:0.015,phase:2,speed:0.02},{color:'rgba(255,255,255,0.6)',amp:25,freq:0.025,phase:4,speed:0.04}];
    function drawWave() {
      const w = canvas.clientWidth, h = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);
      waves.forEach(wave => {
        ctx.beginPath(); ctx.strokeStyle = wave.color; ctx.lineWidth = 3;
        ctx.shadowBlur = 20; ctx.shadowColor = wave.color;
        for (let x=0; x<w; x++) { const y = h/2 + wave.amp * Math.sin(x*wave.freq + wave.phase); x===0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); }
        ctx.stroke(); wave.phase += wave.speed;
      });
      animationFrameId = requestAnimationFrame(drawWave);
    }
    function startWaveAnimation() { if (!animationFrameId) { resizeCanvas(); drawWave(); } }
    function stopWaveAnimation() { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; setTimeout(() => { if(!animationFrameId) ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);}, 100); } }
    window.addEventListener('resize', () => { resizeCanvas(); if(blob.classList.contains('listening')){ startWaveAnimation(); } });
    resizeCanvas();
    
    // --- BUG-FIX: ROBUST ASYNC/AWAIT TYPEWRITER LOOP ---
    document.addEventListener('DOMContentLoaded', () => {
      const h1 = document.querySelector('.blob h1');
      const textToType = "Hello, I'm EDGE AI";
      const typeSpeed = 120;
      const pauseAfterTyping = 1500;
      const pauseBetweenLoops = 10000;

      function typewriterEffect(element, text, speed) {
        return new Promise(resolve => {
          element.textContent = '';
          element.classList.add('typing');
          let i = 0;
          function type() {
            if (i < text.length) {
              element.textContent += text.charAt(i);
              i++;
              setTimeout(type, speed);
            } else {
              // Typing is done, wait a bit then remove cursor and resolve promise
              setTimeout(() => {
                element.classList.remove('typing');
                resolve();
              }, pauseAfterTyping);
            }
          }
          type();
        });
      }

      // This async function will loop forever safely
      async function animationLoop() {
        while (true) {
          await typewriterEffect(h1, textToType, typeSpeed);
          // Wait for the long pause *after* the animation is fully complete
          await new Promise(resolve => setTimeout(resolve, pauseBetweenLoops));
        }
      }

      // Start the safe, robust loop
      animationLoop();
    });
  </script>

  <script>
    (() => {
      const c = document.getElementById('mesh');
      if (!c) return;
      const ctx = c.getContext('2d');
      const DPR = Math.max(1, window.devicePixelRatio || 1);
      const POINTS = 60, SPEED = 0.35, LINK_DIST = 140;
      const DOT_R = 2, DOT_ALPHA = 0.55, LINE_ALPHA = 0.12;
      let w=0, h=0, dots=[];
      function resize(){
        w = c.clientWidth; h = c.clientHeight;
        c.width  = Math.floor(w * DPR); c.height = Math.floor(h * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
        dots = Array.from({length: POINTS}, () => ({
          x: Math.random()*w, y: Math.random()*h,
          dx: (Math.random() - 0.5) * SPEED, dy: (Math.random() - 0.5) * SPEED
        }));
      }
      window.addEventListener('resize', resize, {passive:true});
      resize();
      function step(){
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = `rgba(255,255,255,${DOT_ALPHA})`;
        for (const p of dots){
          p.x += p.dx; p.y += p.dy;
          if (p.x < -10 || p.x > w+10) p.dx *= -1;
          if (p.y < -10 || p.y > h+10) p.dy *= -1;
          ctx.beginPath(); ctx.arc(p.x, p.y, DOT_R, 0, Math.PI*2); ctx.fill();
        }
        for (let i=0;i<dots.length;i++){
          for (let j=i+1;j<dots.length;j++){
            const a=dots[i],b=dots[j],dx=a.x-b.x,dy=a.y-b.y,d2=dx*dx+dy*dy;
            if(d2<LINK_DIST*LINK_DIST){
              const t=1-Math.sqrt(d2)/LINK_DIST;
              ctx.strokeStyle=`rgba(255,255,255,${LINE_ALPHA*(0.4+0.6*t)})`;
              ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        requestAnimationFrame(step);
      }
      step();
    })();
  </script>
</body>
</html>