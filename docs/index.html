<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDGE AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--panel:#1a1a1a;--muted:#9e9e9e;--text:#f5f5f5;--accent:#f26722;--accent2:#333333;--red:#e53935;--input-bg:#0f0f0f;--border:#333333}
    *{box-sizing:border-box}body{margin:0;font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text)}.wrap{min-height:100vh;display:grid;place-items:center;padding:24px}.card{width:min(960px,100%);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:32px;box-shadow:0 20px 60px rgba(0,0,0,.55)}.logo{display:block;max-width:240px;margin:0 auto 20px}.subtitle{text-align:center;color:var(--muted);margin:0 0 28px}.modes{display:flex;gap:12px;justify-content:center;margin:8px 0 12px}.btn{border:0;padding:14px 24px;border-radius:4px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;transition:opacity .2s}.btn:hover{opacity:.9}.primary{background:var(--accent);color:#fff}.secondary{background:var(--accent2);color:var(--text)}.danger{background:var(--red);color:#fff}.hide{display:none}.grid{display:grid;gap:14px}#statusRow{display:flex;align-items:center;justify-content:center;gap:10px;font-size:12px;color:var(--muted)}#statusDot{width:10px;height:10px;border-radius:50%;background:#999}.chatbox{display:grid;grid-template-rows:1fr auto;gap:10px;height:60vh}.msgs{overflow:auto;border-radius:4px;background:var(--input-bg);border:1px solid var(--border);padding:12px;display:grid;gap:10px}.msg{padding:10px 14px;border-radius:4px;line-height:1.5;white-space:pre-wrap}.user{background:#2a2a2a;justify-self:end}.assistant{background:#1c2b33}.row{display:grid;grid-template-columns:1fr auto;gap:8px}textarea{width:100%;background:var(--input-bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:12px;font-family:'Montserrat',sans-serif;resize:none}.tiny{font-size:12px;color:var(--muted);text-align:center}.pill{border-radius:4px;padding:12px 16px;background:var(--input-bg);border:1px solid var(--border);text-align:center}.error{background:#4d1a1a;border:1px solid #8c2a2a;color:#f5c5c5;padding:12px;border-radius:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grid">
      <img src="logo.png" alt="EDGE Learning & Innovation Factory Logo" class="logo" />
      <div class="subtitle">Choose a mode to get started</div>
      <div class="modes">
        <button id="btnChat" class="btn primary">üí¨ Chat</button>
        <button id="btnVoice" class="btn secondary">üéôÔ∏è Voice</button>
      </div>
      <div id="statusRow">
        <div id="statusDot" title="Backend connectivity"></div>
        <span id="modelLabel">Checking backend‚Ä¶</span>
      </div>
      <section id="chatSec" class="grid hide">
        <div class="chatbox">
          <div id="msgs" class="msgs"></div>
          <div id="errBox" class="error hide"></div>
          <div class="row">
            <textarea id="input" rows="3" placeholder="Type a message..."></textarea>
            <button id="send" class="btn primary">Send</button>
          </div>
        </div>
        <div class="tiny" id="footerInfo">‚Äî</div>
      </section>
      <!-- Voice -->
      <section id="voiceSec" class="grid hide">
        <div class="pill" id="status">Tap start to record‚Ä¶</div>
        <div class="modes" style="margin:0 auto"><button id="startRec" class="btn secondary">Start</button><button id="stopRec" class="btn danger" disabled>Stop & Ask</button></div>
        <div class="grid">
          <div class="pill"><strong>Transcript:</strong> <span id="transcript">‚Äî</span></div>
          <div class="pill"><strong>Assistant:</strong> <span id="voiceReply">‚Äî</span></div>
          <audio id="audio" controls class="hide"></audio>
        </div>
      </section>
    </div>
  </div>
  <script>
    const API_BASE = "https://4waiz-edge-v2.hf.space";
    const $ = id => document.getElementById(id);
    const chatSec=$('chatSec'),voiceSec=$('voiceSec'),btnChat=$('btnChat'),btnVoice=$('btnVoice'),statusDot=$('statusDot'),modelLabel=$('modelLabel'),msgsEl=$('msgs'),inputEl=$('input'),sendBtn=$('send'),errBox=$('errBox'),footerInfo=$('footerInfo'),startRec=$('startRec'),stopRec=$('stopRec'),statusEl=$('status'),audioEl=$('audio');
    function show(sec){chatSec.classList.add('hide');voiceSec.classList.add('hide');sec.classList.remove('hide')}
    btnChat.onclick=()=>show(chatSec);btnVoice.onclick=()=>show(voiceSec);
    let messages=[];
    function push(role,content){messages.push({role,content});const d=document.createElement('div');d.className=`msg ${role}`;d.textContent=content;msgsEl.appendChild(d);msgsEl.scrollTop=msgsEl.scrollHeight}
    function setError(msg){errBox.textContent=msg;errBox.classList.remove('hide')}
    async function postJSON(url,payload,timeoutMs=6e4){const t=new AbortController;setTimeout(()=>t.abort(),timeoutMs);const s=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),signal:t.signal});if(!s.ok){const e=await s.text().catch(()=>'');throw new Error(`HTTP ${s.status} ${s.statusText} ‚Äì ${e.slice(0,200)}`)}return await s.json()}
    (async()=>{try{const e=await fetch(`${API_BASE}/health`,{cache:'no-store'});statusDot.style.background=e.ok?'#22c55e':'#ef4444';const t=await fetch(`${API_BASE}/config`).then(e=>e.json()).catch(()=>({}));const s=`Chat: HF (${t.text_model})`;modelLabel.textContent=s;footerInfo.textContent=s+(t.hf_token?' ‚Ä¢ HF token ‚úì':' ‚Ä¢ no HF token');show(chatSec)}catch{statusDot.style.background='#ef4444';modelLabel.textContent='Backend offline'}})();
    async function sendChat(){errBox.classList.add('hide');const t=inputEl.value.trim();if(!t)return;inputEl.value='';push('user',t);sendBtn.disabled=!0;try{const s=await postJSON(`${API_BASE}/chat`,{messages});push('assistant',s.reply||'[no reply]')}catch(s){console.error('Chat error:',s);setError('Error: '+(s.message||'request failed'))}finally{sendBtn.disabled=!1}}
    sendBtn.onclick=sendChat;inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}});
    let mediaRecorder,chunks=[];startRec.onclick=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});mediaRecorder=new MediaRecorder(e);chunks=[];mediaRecorder.ondataavailable=e=>{e.data.size>0&&chunks.push(e.data)};mediaRecorder.onstop=onStop;mediaRecorder.start();startRec.disabled=!0;stopRec.disabled=!1;statusEl.textContent='Recording‚Ä¶'}catch(e){statusEl.textContent='Mic error: '+(e.message||'permission denied')}};stopRec.onclick=()=>{mediaRecorder&&mediaRecorder.state!=='inactive'&&mediaRecorder.stop();startRec.disabled=!1;stopRec.disabled=!0;statusEl.textContent='Processing‚Ä¶'};
    async function onStop(){const e=new Blob(chunks,{type:'audio/webm'});const t=new FormData;t.append('file',e,'voice.webm');try{const s=await fetch(`${API_BASE}/transcribe`,{method:'POST',body:t}),{text:o}=await s.json().catch(()=>({text:''}));$('transcript').textContent=o||'(no transcript)';const a=o&&o.trim()?o:"Say a short hello.",c=await postJSON(`${API_BASE}/chat`,{messages:[{role:'user',content:a}]});$('voiceReply').textContent=c.reply||'';const n=await fetch(`${API_BASE}/speak`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:c.reply||''})}),i=await n.blob();audioEl.src=URL.createObjectURL(i);audioEl.classList.remove('hide');await audioEl.play();statusEl.textContent='Done'}catch(s){console.error('Voice flow error:',s);statusEl.textContent='Error: '+(s.message||'failed')}}
  </script>
</body>
</html>
